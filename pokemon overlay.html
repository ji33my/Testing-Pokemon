<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Next Pokémon Timer</title>
  <style>
    body {
      background: transparent;
      margin: 0;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
      text-align: center;
    }

    #timer {
      font-size: 72px;
      font-weight: 900;
      color: #d62828; /* Pokémon red */
      text-shadow:
        -2px -2px 0 #fff,
         2px -2px 0 #fff,
        -2px  2px 0 #fff,
         2px  2px 0 #fff,
         0px  0px 6px #000;
      line-height: 1;
    }

    #label {
      margin-top: 8px;
      font-size: 28px;
      font-weight: 900;
      color: #d62828;
      text-shadow:
        -2px -2px 0 #fff,
         2px -2px 0 #fff,
        -2px  2px 0 #fff,
         2px  2px 0 #fff,
         0px  0px 4px #000;
      line-height: 1.1;
    }
  </style>
</head>
<body>
  <div id="timer">--:--</div>
  <div id="label">
    Time until<br>
    next Pokémon
  </div>

  <script>
    const API_URL = "https://poketwitch.bframework.de/info/events/last_spawn/?t=1";
    const INTERVAL_MS = 15 * 60 * 1000; // 15 minutes flat
    const CACHE_KEY = "cachedNextSpawnTime";

    let nextSpawnTime = null;

    function formatMMSS(ms) {
      if (ms < 0) ms = 0;
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
      const seconds = String(totalSeconds % 60).padStart(2, "0");
      return `${minutes}:${seconds}`;
    }

    async function fetchNextSpawn() {
      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        const data = await res.json();

        const lastSpawn = new Date(data.event_time).getTime();
        const computedNext = lastSpawn + INTERVAL_MS;

        nextSpawnTime = computedNext;
        localStorage.setItem(CACHE_KEY, String(computedNext));

        console.log("API OK → Next spawn:", new Date(computedNext).toLocaleString());
      } catch (err) {
        console.warn("API failed, using cache...", err);
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
          nextSpawnTime = parseInt(cached, 10);
          console.log("Loaded cached next spawn:", new Date(nextSpawnTime).toLocaleString());
        }
      }
    }

    function updateTimer() {
      if (!nextSpawnTime) return;

      const now = Date.now();
      const remaining = nextSpawnTime - now;

      document.getElementById("timer").textContent = formatMMSS(remaining);

      if (remaining <= 0) {
        fetchNextSpawn();
      }
    }

    fetchNextSpawn();
    setInterval(updateTimer, 250);
  </script>
</body>
</html>
