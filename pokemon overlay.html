<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pokémon Timer</title>
<style>
  body {
    background: transparent;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    font-size: 48px;
    -webkit-text-stroke: 2px black; /* black outline for timer */
  }
  #label {
    font-size: 24px;
    margin-top: 10px;
    -webkit-text-stroke: 1px black; /* outline for label */
  }
</style>
</head>
<body>
<div id="timer">--:--:--</div>
<div id="label">Time until next Pokémon</div>

<script>
const apiUrl = "https://poketwitch.bframework.de/info/events/last_spawn/?t=1";
let nextSpawn = null;

// Base fallback time: 12:04:11 AM EST today
function getFallbackNextSpawn() {
    const now = new Date();
    // Set base time in EST
    const baseTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
    baseTime.setHours(0, 4, 11, 0); // 12:04:11 AM

    // Calculate next spawn after base time in 15 min + 3 sec increments
    const interval = 15 * 60 * 1000 + 3000; // 15 minutes + 3 seconds in ms
    const elapsed = now - baseTime;
    const intervalsPassed = Math.ceil(elapsed / interval);
    return new Date(baseTime.getTime() + intervalsPassed * interval);
}

// Fetch last spawn from API or fallback
async function fetchNextSpawn() {
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if(!data.last_spawn_time) throw new Error("No last spawn time from API");

        const lastSpawn = new Date(data.last_spawn_time);
        if(isNaN(lastSpawn.getTime())) throw new Error("Invalid date format from API");

        // Next spawn 5 minutes after last spawn
        nextSpawn = new Date(lastSpawn.getTime() + 5 * 60 * 1000);
    } catch (err) {
        console.warn("API failed, using fallback:", err);
        nextSpawn = getFallbackNextSpawn();
    }
}

// Update timer every second
function updateTimer() {
    if(!nextSpawn) return;

    const now = new Date();
    let diff = nextSpawn - now;

    if(diff <= 0) {
        // Time's up, calculate next spawn using fallback if API fails
        fetchNextSpawn();
        diff = 0;
    }

    const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
    const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
    const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');

    document.getElementById("timer").textContent = `${hours}:${minutes}:${seconds}`;
}

// Initialize
(async function() {
    await fetchNextSpawn();
    setInterval(updateTimer, 1000);
})();
</script>
</body>
</html>
